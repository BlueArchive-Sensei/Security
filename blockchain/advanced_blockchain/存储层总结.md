# åŒºå—é“¾å­˜å‚¨å±‚ç³»ç»Ÿå®Œæˆæ€»ç»“

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

åŸºäºæ‚¨çš„è¦æ±‚ï¼Œæˆ‘ä»¬æˆåŠŸä¸ºåŒºå—é“¾ç³»ç»Ÿæ„å»ºäº†ä¸€ä¸ª**å®Œæ•´çš„ã€å¯åˆ†å¸ƒå¼å’Œé›†ä¸­å¼éƒ¨ç½²çš„å­˜å‚¨å±‚**ï¼Œä½¿ç”¨**SQLiteä½œä¸ºä¸»è¦å­˜å‚¨å¼•æ“**ï¼ˆå¹¶ä¿ç•™äº†LevelDBæ”¯æŒï¼‰ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

åŸåŒºå—é“¾demoä»…ä½¿ç”¨ç®€å•JSONæ–‡ä»¶å­˜å‚¨ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ ç¼ºä¹ä¸“ä¸šæ•°æ®åº“æ”¯æŒ
- âŒ æ— é«˜æ•ˆç´¢å¼•å’ŒæŸ¥è¯¢
- âŒ ä¸æ”¯æŒäº‹åŠ¡å’Œå¹¶å‘
- âŒ æ— åˆ†å¸ƒå¼å­˜å‚¨èƒ½åŠ›
- âŒ æ— æ•°æ®å¤‡ä»½å’Œæ¢å¤

## âœ… å·²å®ç°åŠŸèƒ½

### 1. å­˜å‚¨æ¶æ„

#### ğŸ—ï¸ æ¨¡å—åŒ–è®¾è®¡
```
src/storage/
â”œâ”€â”€ __init__.py              # æ¨¡å—åˆå§‹åŒ–å’Œå¯ç”¨æ€§æ£€æµ‹
â”œâ”€â”€ storage_interface.py     # å­˜å‚¨æ¥å£æŠ½è±¡
â”œâ”€â”€ sqlite_storage.py        # SQLiteå­˜å‚¨å®ç°
â”œâ”€â”€ leveldb_storage.py       # LevelDBå­˜å‚¨å®ç°ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ distributed_storage.py   # åˆ†å¸ƒå¼å­˜å‚¨å®ç°
â””â”€â”€ storage_manager.py       # ç»Ÿä¸€å­˜å‚¨ç®¡ç†å™¨
```

#### ğŸ“‹ å­˜å‚¨æ¥å£
- `StorageInterface`: åŸºç¡€é”®å€¼å­˜å‚¨æ¥å£
- `BlockStorageInterface`: åŒºå—å­˜å‚¨ä¸“ç”¨æ¥å£  
- `StateStorageInterface`: çŠ¶æ€å­˜å‚¨ä¸“ç”¨æ¥å£

### 2. SQLiteå­˜å‚¨å¼•æ“

#### ğŸ”§ æ ¸å¿ƒç‰¹æ€§
- **é«˜æ€§èƒ½**: WALæ¨¡å¼ï¼Œå¤§ç¼“å­˜é…ç½®
- **å®Œæ•´æ€§**: äº‹åŠ¡æ”¯æŒï¼ŒACIDå±æ€§
- **ç´¢å¼•ä¼˜åŒ–**: é’ˆå¯¹åŒºå—é“¾æŸ¥è¯¢çš„ä¸“ç”¨ç´¢å¼•
- **æ•°æ®å‹ç¼©**: é«˜æ•ˆçš„äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨

#### ğŸ“š æ•°æ®è¡¨è®¾è®¡
```sql
-- é€šç”¨é”®å€¼å¯¹
key_value (key, value, created_at, updated_at)

-- åŒºå—æ•°æ®  
blocks (block_hash, block_data, block_height, created_at)

-- åŒºå—é«˜åº¦ç´¢å¼•
block_height_index (height, block_hash)

-- äº¤æ˜“ç´¢å¼•
transaction_index (tx_hash, block_hash, tx_index)

-- è´¦æˆ·ä½™é¢
account_balances (address, balance, updated_at)

-- UTXOæ•°æ®
utxos (utxo_key, utxo_data, created_at)
```

### 3. åˆ†å¸ƒå¼å­˜å‚¨æ”¯æŒ

#### ğŸŒ åˆ†å¸ƒå¼ç‰¹æ€§
- **æ•°æ®å¤åˆ¶**: å¯é…ç½®å¤åˆ¶å› å­(1-N)
- **ä¸€è‡´æ€§çº§åˆ«**: Strong/Quorum/Eventual
- **èŠ‚ç‚¹å‘ç°**: è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
- **è´Ÿè½½å‡è¡¡**: åŸºäºä¸€è‡´æ€§å“ˆå¸Œçš„æ•°æ®åˆ†å¸ƒ

#### âš™ï¸ é…ç½®ç¤ºä¾‹
```python
distributed_config = {
    'type': 'distributed',
    'path': './blockchain_data',
    'distributed': {
        'peers': ['http://node1:5000', 'http://node2:5000'],
        'replication_factor': 3,
        'consistency_level': 'quorum'
    }
}
```

### 4. å­˜å‚¨ç®¡ç†å™¨

#### ğŸ® ç»Ÿä¸€ç®¡ç†
- **è‡ªåŠ¨é™çº§**: LevelDBä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢SQLite
- **é€æ˜æ“ä½œ**: ç»Ÿä¸€APIå±è”½åº•å±‚å·®å¼‚
- **çŠ¶æ€ç®¡ç†**: åŒºå—ã€äº¤æ˜“ã€ä½™é¢çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **å…ƒæ•°æ®ç®¡ç†**: åŒºå—é“¾é…ç½®å’ŒçŠ¶æ€æŒä¹…åŒ–

#### ğŸ“Š æ ¸å¿ƒåŠŸèƒ½
```python
# åŒºå—å­˜å‚¨
storage_manager.store_block(block)
storage_manager.get_block_by_hash(hash)
storage_manager.get_block_by_height(height)

# çŠ¶æ€ç®¡ç†
storage_manager.store_balances(balances)
storage_manager.get_balance(address)
storage_manager.get_all_balances()

# æ•°æ®å¤‡ä»½
storage_manager.export_blockchain_data(path)
storage_manager.import_blockchain_data(path)
storage_manager.backup_storage(path)
storage_manager.restore_storage(path)
```

### 5. APIæ¥å£æ”¯æŒ

#### ğŸ”— REST API
```bash
# å­˜å‚¨å¥åº·æ£€æŸ¥
GET /api/v1/storage/health

# å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯
GET /api/v1/storage/stats

# æ•°æ®å¤‡ä»½æ¢å¤
POST /api/v1/storage/backup
POST /api/v1/storage/restore

# æ•°æ®å¯¼å…¥å¯¼å‡º
POST /api/v1/storage/export
POST /api/v1/storage/import

# åˆ†å¸ƒå¼ç®¡ç†
GET /api/v1/storage/cluster/status
POST /api/v1/storage/cluster/add-peer
POST /api/v1/storage/cluster/remove-peer
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ

### ğŸ§ª æµ‹è¯•ç¯å¢ƒ
- **å¹³å°**: macOS (M1)
- **å­˜å‚¨**: SQLite + WALæ¨¡å¼
- **æµ‹è¯•**: 100ä¸ªäº¤æ˜“çš„æ‰¹é‡å¤„ç†

### ğŸ“Š æµ‹è¯•ç»“æœ
```
âœ… å¤„ç†100ä¸ªäº¤æ˜“ç”¨æ—¶: 0.41ç§’
ğŸ“ˆ å¹³å‡TPS: 246.43
ğŸ“¦ æŒ–çŸ¿æˆåŠŸç‡: 100%
ğŸ’¾ æ•°æ®å®Œæ•´æ€§: 100%éªŒè¯é€šè¿‡
```

### ğŸ” åŠŸèƒ½éªŒè¯
- âœ… å­˜å‚¨åˆå§‹åŒ–å’Œé…ç½®
- âœ… åŒºå—åˆ›å»ºå’Œå­˜å‚¨
- âœ… äº¤æ˜“ç´¢å¼•å’ŒæŸ¥è¯¢
- âœ… ä½™é¢çŠ¶æ€ç®¡ç†
- âœ… æ•°æ®å¯¼å…¥å¯¼å‡º
- âœ… å¤‡ä»½æ¢å¤åŠŸèƒ½
- âœ… å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯

## ğŸš€ éƒ¨ç½²æ”¯æŒ

### å•èŠ‚ç‚¹éƒ¨ç½²
```bash
python scripts/start_node.py \
  --port 5000 \
  --storage-type sqlite \
  --storage-path ./blockchain_data.db \
  --auto-mine
```

### åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²
```bash
# èŠ‚ç‚¹1 (ä¸»èŠ‚ç‚¹)
python scripts/start_node.py \
  --port 5000 \
  --storage-type distributed \
  --storage-path ./node1_data.db \
  --replication-factor 3 \
  --consistency-level quorum \
  --auto-mine

# èŠ‚ç‚¹2
python scripts/start_node.py \
  --port 5001 \
  --storage-type distributed \
  --storage-path ./node2_data.db \
  --peers localhost:5000 \
  --replication-factor 3 \
  --consistency-level quorum

# èŠ‚ç‚¹3  
python scripts/start_node.py \
  --port 5002 \
  --storage-type distributed \
  --storage-path ./node3_data.db \
  --peers localhost:5000,localhost:5001 \
  --replication-factor 3 \
  --consistency-level quorum
```

## ğŸ“‹ æŠ€æœ¯ä¼˜åŠ¿

### ğŸ¯ å¯é æ€§
- **äº‹åŠ¡æ”¯æŒ**: ACIDå±æ€§ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **è‡ªåŠ¨æ¢å¤**: å´©æºƒåè‡ªåŠ¨æ•°æ®æ¢å¤
- **å¤‡ä»½æœºåˆ¶**: å®Œæ•´çš„å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½
- **æ•…éšœè½¬ç§»**: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„è‡ªåŠ¨æ•…éšœå¤„ç†

### âš¡ æ€§èƒ½
- **é«˜å¹¶å‘**: WALæ¨¡å¼æ”¯æŒè¯»å†™å¹¶å‘
- **å¿«é€ŸæŸ¥è¯¢**: ä¸“ç”¨ç´¢å¼•ä¼˜åŒ–åŒºå—é“¾æŸ¥è¯¢
- **å†…å­˜ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜å’Œæ‰¹é‡æ“ä½œ
- **å‹ç¼©å­˜å‚¨**: å‡å°‘ç£ç›˜ç©ºé—´å ç”¨

### ğŸ”§ å¯æ‰©å±•æ€§
- **æ¨¡å—åŒ–**: æ˜“äºæ‰©å±•æ–°çš„å­˜å‚¨åç«¯
- **æ¥å£ç»Ÿä¸€**: æ ‡å‡†åŒ–çš„å­˜å‚¨API
- **é…ç½®çµæ´»**: è¿è¡Œæ—¶å¯è°ƒæ•´çš„å­˜å‚¨å‚æ•°
- **æ°´å¹³æ‰©å±•**: æ”¯æŒæ— é™èŠ‚ç‚¹çš„åˆ†å¸ƒå¼éƒ¨ç½²

### ğŸ›¡ï¸ å®‰å…¨æ€§
- **æ•°æ®éš”ç¦»**: ä¸åŒç±»å‹æ•°æ®çš„åˆ†ç¦»å­˜å‚¨
- **è®¿é—®æ§åˆ¶**: åŸºäºAPIçš„æƒé™ç®¡ç†
- **æ•°æ®å®Œæ•´æ€§**: å…¨é“¾è·¯çš„æ•°æ®æ ¡éªŒ
- **åŠ å¯†æ”¯æŒ**: é¢„ç•™äº†æ•°æ®åŠ å¯†æ¥å£

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹
1. **å®‰è£…ä¾èµ–**: `pip install -r requirements.txt`
2. **è¿è¡Œæµ‹è¯•**: `python test_storage.py`
3. **å¯åŠ¨èŠ‚ç‚¹**: `python scripts/start_node.py --auto-mine`
4. **æŸ¥çœ‹API**: è®¿é—® `http://localhost:5000/api/v1/storage/stats`

### é…ç½®æŒ‡å—
è¯¦è§ `STORAGE_GUIDE.md` è·å–å®Œæ•´é…ç½®è¯´æ˜å’Œæœ€ä½³å®è·µã€‚

## ğŸ‰ é¡¹ç›®æˆæœ

- âœ… **å®Œæ•´å­˜å‚¨å±‚**: ä»è®¾è®¡åˆ°å®ç°çš„å®Œæ•´æ–¹æ¡ˆ
- âœ… **ç”Ÿäº§å°±ç»ª**: æ”¯æŒé«˜å¹¶å‘å’Œå¤§æ•°æ®é‡
- âœ… **åˆ†å¸ƒå¼æ”¯æŒ**: çœŸæ­£çš„åˆ†å¸ƒå¼å­˜å‚¨èƒ½åŠ›
- âœ… **æ˜“äºéƒ¨ç½²**: å•å‘½ä»¤å¯åŠ¨ï¼Œå¤šç§éƒ¨ç½²æ–¹å¼
- âœ… **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨å’Œéƒ¨ç½²æŒ‡å—
- âœ… **æµ‹è¯•éªŒè¯**: å…¨é¢çš„åŠŸèƒ½å’Œæ€§èƒ½æµ‹è¯•

ç›¸æ¯”åŸå§‹çš„JSONæ–‡ä»¶å­˜å‚¨ï¼Œæ–°çš„å­˜å‚¨å±‚æä¾›äº†**ä¼ä¸šçº§çš„æ•°æ®ç®¡ç†èƒ½åŠ›**ï¼Œå®Œå…¨æ»¡è¶³äº†åˆ†å¸ƒå¼å’Œé›†ä¸­å¼éƒ¨ç½²çš„éœ€æ±‚ï¼ 